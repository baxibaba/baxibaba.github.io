<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Docker 容器版的 zabbix 监控报警系统搭建 &mdash; Diego.blog</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/collection.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/common.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->
    

    
    <link rel="canonical" href="http://localhost:4000/2018/03/15/docker-zabbix-email/">
    <link rel="alternate" type="application/atom+xml" title="Diego.blog" href="http://localhost:4000/feed.xml">
    <link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
    
    <meta property="og:title" content="Docker 容器版的 zabbix 监控报警系统搭建">
      
    <meta name="keywords" content="docker, zabbix, centos7, mysql">
    <meta name="og:keywords" content="docker, zabbix, centos7, mysql">
      
    <meta name="description" content="zabbix 是一个流行的开源监控报警系统，这次使用 docker 容器来发布 zabbix ，以下分享安装的整个过程。">
    <meta name="og:description" content="zabbix 是一个流行的开源监控报警系统，这次使用 docker 容器来发布 zabbix ，以下分享安装的整个过程。">
      
    
    
        
    
    <meta property="og:url" content="http://localhost:4000/2018/03/15/docker-zabbix-email/">
    <meta property="og:site_name" content="Diego.blog">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />
    
    <meta property="article:published_time" content="2018-03-15">
    
    <script src="http://localhost:4000/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="http://localhost:4000/assets/js/jquery-ui.js"></script>
    <script type="text/javascript">
    function toggleMenu() {
        var nav = document.getElementsByClassName("site-header-nav")[0];
        if (nav.style.display == "inline-flex") {
          nav.style.display = "none";
        } else {
          nav.style.display = "inline-flex";
        }
    }
    </script>
</head>
<body class="" data-mz="">
    <header class="site-header">
        <div class="container">
            <h1><a href="http://localhost:4000/" title="Diego.blog"><span class="octicon octicon-mark-github"></span> Diego.blog</a></h1>
            <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <nav class="site-header-nav" role="navigation">
                
                <a href="http://localhost:4000/" class=" site-header-nav-item" target="" title="首页">首页</a>
                
                <a href="http://localhost:4000/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>
                
                <a href="http://localhost:4000/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a>
                
                <a href="http://localhost:4000/links/" class=" site-header-nav-item" target="" title="链接">链接</a>
                
                <a href="http://localhost:4000/about/" class=" site-header-nav-item" target="" title="关于">关于</a>
                
            </nav>
        </div>
    </header>
    <!-- / header -->

    <section class="collection-head small geopattern" data-pattern-id="Docker 容器版的 zab">
<div class="container">
  <div class="columns">
    <div class="column three-fourths">
      <div class="collection-title">
        <h1 class="collection-header">Docker 容器版的 zabbix 监控报警系统搭建</h1>
        <div class="collection-info">
          
          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2018/03/15
          </span>
          
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#docker," title="docker,">docker,</a>
          </span>
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#zabbix," title="zabbix,">zabbix,</a>
          </span>
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#centos7," title="centos7,">centos7,</a>
          </span>
          
          <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="http://localhost:4000/categories/#mysql" title="mysql">mysql</a>
          </span>
          
        </div>
      </div>
    </div>
  </div>
</div>
</section>
<!-- / .banner -->
<section class="container content">
<div class="columns">
  <div class="column three-fourths" >
    <article class="article-content markdown-body">
    <p>zabbix 是一个流行的开源监控报警系统，这次使用 docker 容器来发布 zabbix ，以下分享安装的整个过程。</p>

<h3 id="监控的目的">监控的目的</h3>

<p>主要关注点是系统层，服务器CPU、memory、IO这些基础指标参数，并实现一个邮件报警功能，邮件关联企业微信，这样就能方便的在移动端及时收到报警邮件了。</p>

<hr />

<h3 id="安装-zabbix-监控的数据库">安装 zabbix 监控的数据库</h3>

<p><a href="https://hub.docker.com/r/monitoringartist/zabbix-db-mariadb/">zabbix-db-mariadb官网</a></p>

<p>网上大部分资料都是从创建一个 mariadb 数据库开始的：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">rm</span> <span class="nt">-f</span> zabbix-db

<span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">--name</span> zabbix-db <span class="nt">-p</span> 5000:3306 <span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
  <span class="nt">--env</span><span class="o">=</span><span class="s2">"MARIADB_USER=设置一个库用户名"</span> <span class="se">\</span>
  <span class="nt">--env</span><span class="o">=</span><span class="s2">"MARIADB_PASS=设置一个密码"</span> <span class="se">\</span>
  <span class="nt">--env</span><span class="o">=</span><span class="s2">"DB_innodb_buffer_pool_size=512M"</span> <span class="se">\</span>
  <span class="nt">--env</span><span class="o">=</span><span class="s2">"DB_innodb_log_file_size=64M"</span> <span class="se">\</span>
  <span class="nt">-v</span> /etc/localtime:/etc/localtime:ro <span class="se">\</span>
  <span class="nt">-v</span> /home/docker/zabbix-db/data:/var/lib/mysql <span class="se">\</span>
  <span class="nt">-v</span> /home/docker/zabbix-db/backups:/backups <span class="se">\</span>
  reg.blf1.org/monitoringartist/zabbix-db-mariadb:latest

<span class="c"># 查看日志输出</span>
<span class="nv">$ </span>docker logs <span class="nt">-f</span> zabbix-db
<span class="o">=&gt;</span> An empty/uninitialized MariaDB volume is detected <span class="k">in</span> /var/lib/mysql
<span class="o">=&gt;</span> Installing MariaDB...
<span class="o">=&gt;</span> Installing MariaDB... Done!
<span class="nt">-----------------</span> Previous error log <span class="nt">-----------------</span>
171025 11:34:29 <span class="o">[</span>Note] InnoDB: Starting shutdown...
171025 11:34:30 <span class="o">[</span>Note] InnoDB: Waiting <span class="k">for </span>page_cleaner to finish flushing of buffer pool
171025 11:34:31 <span class="o">[</span>Note] InnoDB: Shutdown completed<span class="p">;</span> log sequence number 1616697
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Using mutexes to ref count buffer pool pages
171025 11:34:32 <span class="o">[</span>Note] InnoDB: The InnoDB memory heap is disabled
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
171025 11:34:32 <span class="o">[</span>Note] InnoDB: GCC <span class="nb">builtin </span>__atomic_thread_fence<span class="o">()</span> is used <span class="k">for </span>memory barrier
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Compressed tables use zlib 1.2.7
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Using Linux native AIO
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Using CPU crc32 instructions
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Initializing buffer pool, size <span class="o">=</span> 512.0M
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Completed initialization of buffer pool
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Highest supported file format is Barracuda.
171025 11:34:32 <span class="o">[</span>Note] InnoDB: 128 rollback segment<span class="o">(</span>s<span class="o">)</span> are active.
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Waiting <span class="k">for </span>purge to start
171025 11:34:32 <span class="o">[</span>Note] InnoDB:  Percona XtraDB <span class="o">(</span>http://www.percona.com<span class="o">)</span> 5.6.36-82.1 started<span class="p">;</span> log sequence number 1616697
171025 11:34:32 <span class="o">[</span>Note] InnoDB: FTS optimize thread exiting.
171025 11:34:32 <span class="o">[</span>Note] InnoDB: Starting shutdown...
171025 11:34:33 <span class="o">[</span>Note] InnoDB: Waiting <span class="k">for </span>page_cleaner to finish flushing of buffer pool
171025 11:34:34 <span class="o">[</span>Note] InnoDB: Shutdown completed<span class="p">;</span> log sequence number 1616707
<span class="nt">-----------------</span> Previous error log ends <span class="nt">-----------------</span>

Waiting <span class="k">for </span>DB service...
Still waiting <span class="k">for </span>DB service...
171025 11:34:35 mysqld_safe Logging to <span class="s1">'/var/lib/mysql/error.log'</span><span class="nb">.</span>
171025 11:34:35 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql
171025 11:34:35 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql
171025 11:34:35 <span class="o">[</span>Warning] options <span class="nt">--log-slow-admin-statements</span>, <span class="nt">--log-queries-not-using-indexes</span> and <span class="nt">--log-slow-slave-statements</span> have no effect <span class="k">if</span> <span class="nt">--log_slow_queries</span> is not <span class="nb">set
</span>171025 11:34:35 <span class="o">[</span>Note] /usr/sbin/mysqld <span class="o">(</span>mysqld 10.0.32-MariaDB<span class="o">)</span> starting as process 341 ...
171025 11:34:35 <span class="o">[</span>Warning] Could not increase number of max_open_files to more than 4096 <span class="o">(</span>request: 4407<span class="o">)</span>
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Using mutexes to ref count buffer pool pages
171025 11:34:35 <span class="o">[</span>Note] InnoDB: The InnoDB memory heap is disabled
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
171025 11:34:35 <span class="o">[</span>Note] InnoDB: GCC <span class="nb">builtin </span>__atomic_thread_fence<span class="o">()</span> is used <span class="k">for </span>memory barrier
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Compressed tables use zlib 1.2.7
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Using Linux native AIO
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Using CPU crc32 instructions
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Initializing buffer pool, size <span class="o">=</span> 512.0M
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Completed initialization of buffer pool
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Highest supported file format is Barracuda.
171025 11:34:35 <span class="o">[</span>Note] InnoDB: 128 rollback segment<span class="o">(</span>s<span class="o">)</span> are active.
171025 11:34:35 <span class="o">[</span>Note] InnoDB: Waiting <span class="k">for </span>purge to start
171025 11:34:35 <span class="o">[</span>Note] InnoDB:  Percona XtraDB <span class="o">(</span>http://www.percona.com<span class="o">)</span> 5.6.36-82.1 started<span class="p">;</span> log sequence number 1616707
171025 11:34:35 <span class="o">[</span>Note] Plugin <span class="s1">'FEEDBACK'</span> is disabled.
171025 11:34:35 <span class="o">[</span>Note] Server socket created on IP: <span class="s1">'0.0.0.0'</span><span class="nb">.</span>
171025 11:34:35 <span class="o">[</span>Warning] <span class="s1">'user'</span> entry <span class="s1">'root@fc28ae2c6c51'</span> ignored <span class="k">in</span> <span class="nt">--skip-name-resolve</span> mode.
171025 11:34:35 <span class="o">[</span>Warning] <span class="s1">'user'</span> entry <span class="s1">'@fc28ae2c6c51'</span> ignored <span class="k">in</span> <span class="nt">--skip-name-resolve</span> mode.
171025 11:34:35 <span class="o">[</span>Warning] <span class="s1">'proxies_priv'</span> entry <span class="s1">'@% root@fc28ae2c6c51'</span> ignored <span class="k">in</span> <span class="nt">--skip-name-resolve</span> mode.
171025 11:34:35 <span class="o">[</span>Note] Reading of all Master_info entries succeded
171025 11:34:35 <span class="o">[</span>Note] Added new Master_info <span class="s1">''</span> to <span class="nb">hash </span>table
171025 11:34:35 <span class="o">[</span>Note] /usr/sbin/mysqld: ready <span class="k">for </span>connections.
Version: <span class="s1">'10.0.32-MariaDB'</span>  socket: <span class="s1">'/var/lib/mysql/mysql.sock'</span>  port: 3306  MariaDB Server
171025 11:34:35 <span class="o">[</span>Note] /usr/sbin/mysqld: ready <span class="k">for </span>connections.
Securing and tidying DB...
Securing and tidying DB... Done!
Showing DB status...

<span class="nt">--------------</span>
mysql  Ver 15.1 Distrib 10.0.32-MariaDB, <span class="k">for </span>Linux <span class="o">(</span>x86_64<span class="o">)</span> using readline 5.1

Connection <span class="nb">id</span>:          6
Current database:
Current user:           root@127.0.0.1
SSL:                    Not <span class="k">in </span>use
Current pager:          stdout
Using outfile:          <span class="s1">''</span>
Using delimiter:        <span class="p">;</span>
Server:                 MariaDB
Server version:         10.0.32-MariaDB MariaDB Server
Protocol version:       10
Connection:             localhost via TCP/IP
Server characterset:    utf8
Db     characterset:    utf8
Client characterset:    utf8
Conn.  characterset:    utf8
TCP port:               3306
Uptime:                 1 sec

Threads: 1  Questions: 16  Slow queries: 1  Opens: 1  Flush tables: 1  Open tables: 64  Queries per second avg: 16.000
<span class="nt">--------------</span>

Creating DB admin user...

<span class="o">=&gt;</span> Creating MariaDB user <span class="s1">'admin'</span> with <span class="s1">'zabbixxxx2017'</span> password.
<span class="o">========================================================================</span>
    You can now connect to this MariaDB Server using:                   
    mysql <span class="nt">-uadmin</span> <span class="nt">-pzabbixAdmin2017</span> <span class="nt">-h</span>&lt;host&gt;                      

    For security reasons, you might want to change the above password.  
    The <span class="s1">'root'</span> user has no password but only allows <span class="nb">local </span>connections   
<span class="o">========================================================================</span>
</code></pre></div></div>

<p>测试数据库连接（mariadb 跟 mysql 类似，这里直接使用 mysql 的客户端进行连接测试）</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-h172</span>.20.32.44 <span class="nt">-uadmin</span> <span class="nt">-pzabbixxxx2017</span> <span class="nt">-P5000</span> <span class="nt">-e</span><span class="s2">"show databases"</span>
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
+--------------------+

<span class="nv">$ </span>mysql <span class="nt">-h172</span>.20.32.44 <span class="nt">-uadmin</span> <span class="nt">-pzabbixAdmin2017</span> <span class="nt">-P5000</span> <span class="nt">-e</span><span class="s2">"select version()"</span>
+-----------------+
| version<span class="o">()</span>       |
+-----------------+
| 10.0.32-MariaDB |
+-----------------+
</code></pre></div></div>

<h4 id="数据库备份">数据库备份</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> zabbix-db <span class="se">\</span>
  /zabbix-backup/zabbix-mariadb-dump <span class="nt">-u</span> admin <span class="nt">-p</span> zabbixxxx2017 <span class="nt">-o</span> /backups
Configuration:
 - host:     127.0.0.1 <span class="o">(</span>localhost<span class="o">)</span>
 - database: zabbix
 - user:     admin
 - output:   /backups

Fetching list of existing tables...
Starting table backups...
0%.......12%12%.......24%.......36%.......48%.......60%60%.......72%72%.......84%.......96%..

For the following large tables only the schema <span class="o">(</span>without data<span class="o">)</span> was stored:
 - acknowledges
 - alerts
 - auditlog
 - auditlog_details
 - events
 - <span class="nb">history</span>
 - history_log
 - history_str
 - history_text
 - history_uint
 - trends
 - trends_uint

Compressing backup file...

Backup Completed:
/backups/zabbix_cfg_localhost_20171025-1650_db-3.4.5.sql.gz

<span class="nv">$ </span><span class="nb">ls</span> /home/docker/zabbix-db/backups/
zabbix_cfg_localhost_20171025-1650_db-3.4.5.sql.gz
</code></pre></div></div>

<h4 id="数据库还原">数据库还原</h4>

<p>其实就是 mysqldump 相关的操作，这里暂不折腾。</p>

<hr />

<h3 id="安装-zabbix-server">安装 Zabbix Server</h3>

<p><a href="https://hub.docker.com/r/zabbix/zabbix-server-mysql/">Zabbix Server官方介绍</a></p>

<p>What is Zabbix server?
Zabbix server is the central process of Zabbix software.</p>

<p>The server performs the polling and trapping of data, it calculates triggers, sends notifications to users. It is the central component to which Zabbix agents and proxies report data on availability and integrity of systems. The server can itself remotely check networked services (such as web servers and mail servers) using simple service checks.</p>

<p>Zabbix server 是此套监控的服务端，核心组件。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">rm</span> <span class="nt">-f</span> zabbix-server

<span class="nv">$ </span>docker run  <span class="nt">--name</span> zabbix-server <span class="nt">--hostname</span> zabbix-server <span class="se">\</span>
<span class="nt">--link</span> zabbix-db:mysql <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DB_SERVER_HOST</span><span class="o">=</span><span class="s2">"mysql"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_USER</span><span class="o">=</span><span class="s2">"库用户名"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_DATABASE</span><span class="o">=</span><span class="s2">"zabbix"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span><span class="s2">"库密码"</span> <span class="se">\</span>
<span class="nt">-v</span> /etc/localtime:/etc/localtime:ro <span class="se">\</span>
<span class="nt">-v</span> /data/docker/zabbix/alertscripts:/usr/lib/zabbix/alertscripts <span class="se">\</span>
<span class="nt">-v</span> /data/docker/zabbix/externalscripts:/usr/lib/zabbix/externalscripts <span class="se">\</span>
<span class="nt">-p</span> 10051:10051 <span class="se">\</span>
<span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
<span class="nt">-d</span> <span class="se">\</span>
zabbix/zabbix-server-mysql:3.4.5
</code></pre></div></div>

<p>部署 zabbix-web-nginx</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--name</span> zabbix-web-nginx <span class="nt">--hostname</span> zabbix-web-nginx <span class="se">\</span>
<span class="nt">--link</span> zabbix-db:mysql <span class="se">\</span>
<span class="nt">--link</span> zabbix-server:zabbix-server <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">DB_SERVER_HOST</span><span class="o">=</span><span class="s2">"mysql"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_USER</span><span class="o">=</span><span class="s2">"库账号"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span><span class="s2">"库密码"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_DATABASE</span><span class="o">=</span><span class="s2">"zabbix"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">ZBX_SERVER_HOST</span><span class="o">=</span><span class="s2">"zabbix-server"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">PHP_TZ</span><span class="o">=</span><span class="s2">"Asia/Shanghai"</span> <span class="se">\</span>
<span class="nt">-p</span> 8000:80 <span class="se">\</span>
<span class="nt">-p</span> 8443:443 <span class="se">\</span>
<span class="nt">-d</span> <span class="se">\</span>
zabbix/zabbix-web-nginx-mysql:3.4.5
</code></pre></div></div>

<p>Wait ~30 seconds for Zabbix initialization</p>

<p>Zabbix web will be available on the port 8000, Zabbix server on the port 9000</p>

<p>Zabbix server Default credentials: Admin/zabbix</p>

<p>在容器起来以后，可以通过 <code class="language-plaintext highlighter-rouge">http://172.20.32.44:8000</code>（此处IP地址为容器所在宿主机IP，需要改成自己环境的） 访问 zabbix 的 web 界面了：</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180323151202889.png" alt="zabbix22" /></p>

<p>登录成功后，可以看到 zabbix server 的界面：</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180323151322730.png" alt="zabbixx23" /></p>

<p>点击右上角的用户图标，可以进行用户的设置，比如：更改字符集为中文（对于新手会比较友好）</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180323151436299.png" alt="zabbix24" /></p>

<h4 id="使用自建的-mysql-数据库">使用自建的 mysql 数据库</h4>

<p>经过初步验证，发现直接使用已搭建好的 mysql 数据库也是可以的，这样数据就比较集中，也不用操心数据备份的事情的，数据库备份策略会统一做。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">rm</span> <span class="nt">-f</span> zabbix-mysql

docker run <span class="nt">--name</span> zabbix-mysql <span class="nt">--hostname</span> zabbix-mysql <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="s2">"库的root密码"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_USER</span><span class="o">=</span><span class="s2">"zabbix"</span> <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>“zabbix用户密码” <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">MYSQL_DATABASE</span><span class="o">=</span><span class="s2">"zabbix"</span> <span class="se">\</span>
<span class="nt">-v</span> /home/docker/mysql_3306/custom:/etc/mysql/conf.d <span class="se">\</span>
<span class="nt">-v</span> /home/docker/mysql_3306/data:/var/lib/mysql/ <span class="se">\</span>
<span class="nt">-p</span> 3306:3306 <span class="se">\</span>
<span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
<span class="nt">-d</span> registry.eyd.com:5000/library/mysql:5.7.14 <span class="se">\</span>
<span class="nt">--character-set-server</span><span class="o">=</span>utf8 <span class="nt">--collation-server</span><span class="o">=</span>utf8_bin
</code></pre></div></div>

<p>熟悉 mysql 的小伙伴，选择自建的 mysql 库做为 zabbix server 的后端存储，很不错哦。</p>

<hr />

<h3 id="安装-zabbix-agent">安装 Zabbix Agent</h3>

<p><a href="https://hub.docker.com/r/zabbix/zabbix-agent/">zabbix_agent官网说明</a></p>

<p>What is Zabbix agent?</p>

<p>Zabbix agent is deployed on a monitoring target to actively monitor local resources and applications (hard drives, memory, processor statistics etc).</p>

<p>Zabbix Agent 是被监控目标端上的数据采集工具。</p>

<p>在每个客户端运行：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker rm -f zabbix-agent

$ docker run --name zabbix-agent \
--net=host \
-e ZBX_HOSTNAME="给个计算名" \
-e ZBX_SERVER_HOST="Zabbix server IP" \
--restart=always \
-d zabbix/zabbix-agent:3.4.5

</code></pre></div></div>

<p>您可以使用几乎任何代理配置参数，只需添加前缀ZBX_</p>

<p>如果不指定自定义设置变量，则将使用默认的 Zabbix agent 设置。</p>

<p>例如，要使用 StartAgents=10，只需添加环境变量-e “ZBX_STARTAGENTS=10”。</p>

<p>容器重启，停用，删除都是可以的，不影响使用。 客户端启动成功后，发现已经被自动注册到服务端，如果没有，可以手工创建主机。</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180323114041815.png" alt="zabbix21" /></p>

<hr />

<h3 id="配置-zabbix-邮件告警功能">配置 Zabbix 邮件告警功能</h3>

<h4 id="使用自带的-email">使用自带的 Email</h4>

<p>参见 <a href="https://www.zabbix.com/documentation/3.4/zh/manual/config/notifications/media/script">官方文档 Zabbix Documentation 3.4</a></p>

<p>1、设置报警媒介，通俗讲就是设置一个发件邮箱
<img src="/images/posts/zabbix/markdown-img-paste-20180323095530905.png" alt="zabbix13" />
<img src="/images/posts/zabbix/markdown-img-paste-20180323095853923.png" alt="zabbix14" /></p>

<p>关于邮箱的选择，原则上任何一家服务商提供的邮箱都可以，相信大家都想申请一个专用邮箱用来发送报警邮件，包括博主我也是。<strong>在尝试了QQ，163邮箱后，发现新注册的邮箱都是没有开通SMTP这些功能的（没有此功能，设置了无法正常发送邮件，坑），想要使用此功能，15天后才能申请开通，真是太揪心了。</strong>绕了一圈，还是公司的企业邮箱（也是企鹅厂的产品）最好用。</p>

<p>2、配置–动作，设置邮件触发条件和邮件格式的地方
<img src="/images/posts/zabbix/markdown-img-paste-20180323103958238.png" alt="zabbix15" />
<img src="/images/posts/zabbix/markdown-img-paste-2018032310403210.png" alt="zabbix16" />
<img src="/images/posts/zabbix/markdown-img-paste-20180323104100226.png" alt="zabbix17" /></p>

<p>选择触发条件，以固定邮件格式告警，这里贴几个改过的格式出来，添加了中文，增强可读性。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 操作</span>
<span class="o">[</span>告警触发] <span class="o">{</span>TRIGGER.NAME<span class="o">}</span>
告警时间：<span class="o">{</span>EVENT.DATE<span class="o">}</span> <span class="o">{</span>EVENT.TIME<span class="o">}</span>
告  警  IP：<span class="o">{</span>HOST.IP<span class="o">}</span>
告警主机：<span class="o">{</span>HOSTNAME1<span class="o">}</span>
告警等级：<span class="o">{</span>TRIGGER.SEVERITY<span class="o">}</span>
告警信息：<span class="o">{</span>TRIGGER.NAME<span class="o">}</span>
告警项目：<span class="o">{</span>TRIGGER.KEY1<span class="o">}</span>
问题详情：<span class="o">{</span>ITEM.NAME<span class="o">}</span>
当前状态：<span class="o">{</span>TRIGGER.STATUS<span class="o">}</span>
当  前  值：<span class="o">{</span>ITEM.VALUE1<span class="o">}</span>
事  件  ID：<span class="o">{</span>EVENT.ID<span class="o">}</span>

<span class="c"># 恢复操作</span>
<span class="o">[</span>告警恢复] <span class="o">{</span>TRIGGER.NAME<span class="o">}</span>
恢复时间：<span class="o">{</span>EVENT.DATE<span class="o">}</span> <span class="o">{</span>EVENT.TIME<span class="o">}</span>
告  警  IP：<span class="o">{</span>HOST.IP<span class="o">}</span>
告警主机：<span class="o">{</span>HOSTNAME1<span class="o">}</span>
告警等级：<span class="o">{</span>TRIGGER.SEVERITY<span class="o">}</span>
告警信息：<span class="o">{</span>TRIGGER.NAME<span class="o">}</span>
告警项目：<span class="o">{</span>TRIGGER.KEY1<span class="o">}</span>
问题详情：<span class="o">{</span>ITEM.NAME<span class="o">}</span>
当前状态：<span class="o">{</span>TRIGGER.STATUS<span class="o">}</span>
当  前  值：<span class="o">{</span>ITEM.VALUE1<span class="o">}</span>
原事件ID：<span class="o">{</span>EVENT.ID<span class="o">}</span>
<span class="o">{</span>TRIGGER.URL<span class="o">}</span>

<span class="c"># 确认操作</span>
<span class="o">[</span>告警确认]  <span class="o">{</span>TRIGGER.NAME<span class="o">}</span>
<span class="o">{</span>USER.FULLNAME<span class="o">}</span> acknowledged problem at <span class="o">{</span>ACK.DATE<span class="o">}</span> <span class="o">{</span>ACK.TIME<span class="o">}</span> with the following message:
<span class="o">{</span>ACK.MESSAGE<span class="o">}</span>

Current problem status is <span class="o">{</span>EVENT.STATUS<span class="o">}</span>

</code></pre></div></div>

<p>3、管理–用户，设置收件人
<img src="/images/posts/zabbix/markdown-img-paste-20180323105433740.png" alt="zabbix18" />
<img src="/images/posts/zabbix/markdown-img-paste-20180323105529240.png" alt="zabbix19" />
<img src="/images/posts/zabbix/markdown-img-paste-20180323105603871.png" alt="zabbix20" /></p>

<p>这个地方注意，<strong>如果没有邮件组，要给多人发送邮件的话，得添加多条，默认一条只支持设置一个邮箱，如果设置多个邮箱，亲测无效。</strong></p>

<h4 id="使用自定义告警功能">使用自定义告警功能</h4>

<p><a href="http://www.cnblogs.com/rysinal/p/5834421.html">zabbix3.0.4 邮件告警详细配置</a></p>

<p>除了自带的邮件告警功能，zabbix 还支持自定义告警，如使用 sendEmail 工具，也是可以成功的。相比自带的 Email 增加了对 html 格式邮件的支持。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> zabbix bash

<span class="nv">$ </span>wget http://caspian.dotconf.net/menu/Software/SendEmail/sendEmail-v1.56.tar.gz

<span class="nv">$ </span><span class="nb">tar </span>zxf sendEmail-v1.56.tar.gz <span class="nt">-C</span> /usr/src

<span class="nv">$ </span><span class="nb">cd</span> /usr/src/sendEmail-v1.56

<span class="nv">$ </span><span class="nb">cp</span> <span class="nt">-a</span> sendEmail /usr/local/bin

<span class="nv">$ </span><span class="nb">chmod</span> +x /usr/local/bin/sendEmail

<span class="c"># 测试邮件功能</span>
<span class="nv">$ </span>/usr/local/bin/sendEmail <span class="se">\</span>
  <span class="nt">-f</span> 你的邮件账号 <span class="se">\</span>
  <span class="nt">-t</span> 你的邮件账号 <span class="se">\</span>
  <span class="nt">-s</span> 你的邮件服务器 <span class="se">\</span>
  <span class="nt">-u</span> <span class="s2">"我是邮件主题"</span> <span class="se">\</span>
  <span class="nt">-o</span> message-content-type<span class="o">=</span>html <span class="se">\</span>
  <span class="nt">-o</span> message-charset<span class="o">=</span>utf8 <span class="se">\</span>
  <span class="nt">-o</span> <span class="nv">tls</span><span class="o">=</span>no <span class="se">\</span>
  <span class="nt">-xu</span> 你的邮件账号 <span class="se">\</span>
  <span class="nt">-xp</span> 这里是密码 <span class="se">\</span>
  <span class="nt">-m</span> <span class="s2">"我是邮件内容"</span>

<span class="c"># 增加自定义警告发送脚本</span>
<span class="nv">$ </span> <span class="nb">tee</span> /usr/local/share/zabbix/alertscripts/sendEmail.sh <span class="o">&lt;&lt;-</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">'
#!/bin/bash

to=</span><span class="nv">$1</span><span class="sh">
subject=</span><span class="nv">$2</span><span class="sh">
body=</span><span class="nv">$3</span><span class="sh">

/usr/local/bin/sendEmail  
  -f 你的邮件账号 </span><span class="se">\</span><span class="sh">
  -t "</span><span class="nv">$to</span><span class="sh">"
  -s 你的邮件服务器 </span><span class="se">\</span><span class="sh">
  -u "</span><span class="nv">$subject</span><span class="sh">"
  -o message-content-type=html </span><span class="se">\</span><span class="sh">
  -o message-charset=utf8 </span><span class="se">\</span><span class="sh">
  -o tls=no </span><span class="se">\</span><span class="sh">
  -xu 你的邮件账号 </span><span class="se">\</span><span class="sh">
  -xp 这里是密码 </span><span class="se">\</span><span class="sh">
  -m "</span><span class="nv">$body</span><span class="sh">"
</span><span class="no">EOF

</span><span class="nv">$ </span><span class="nb">chmod</span> +x /usr/local/share/zabbix/alertscripts/sendEmail.sh

<span class="nv">$ </span><span class="nb">chown </span>zabbix.zabbix /usr/local/share/zabbix/alertscripts/sendEmail.sh
</code></pre></div></div>

<p>然后按照教程一步步在管理界面配置就能成功，需要一些耐心。</p>

<p>相较而言，zabbix 自带的邮件告警功能已经能满足基本需求，不用安装额外的软件，相对简单。有些 zabbix 容器中并不支持安装软件，需要重新封装镜像来支持，还是蛮花时间的，不推荐。</p>

<hr />

<h3 id="监控服务器内存">监控服务器内存</h3>

<p>zabbix默认的剩余内存报警，值设置过小，小于20M才报警太晚了。</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Average Lack of available memory on server <span class="o">{</span>HOST.NAME<span class="o">}{</span>Template OS Linux:vm.memory.size[available].last<span class="o">(</span>0<span class="o">)}</span>&lt;20M
</code></pre></div></div>

<p>实际上，当内存不足10%的时候就需要配置报警，下面我们来完成此项配置。
1、创建item(监控项)</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Configuration--&gt;Templates--&gt;Template OS Linux--&gt;items--&gt;create item

name:
Ava memory percent
<span class="nb">type</span>:
Calculated <span class="c">#计算类型</span>
key:
vm.memory.free[percent]
Formula：
100<span class="k">*</span>last<span class="o">(</span><span class="s2">"vm.memory.size[available]"</span><span class="o">)</span>/last<span class="o">(</span><span class="s2">"vm.memory.size[total]"</span><span class="o">)</span>
Applications：
Memory
</code></pre></div></div>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321085405470.png" alt="z01" /></p>

<p>2、创建trigger（触发器）</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Configuration--&gt;Templates--&gt;Template OS Linux--&gt;Triggers--&gt;create trigger
Name:
free mem less 10%
Expression:
<span class="o">{</span>Template OS Linux:vm.memory.free[percent].last<span class="o">()}</span>&lt;10
</code></pre></div></div>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321090120105.png" alt="zabbix02" /></p>

<p>3、报警信息效果图</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-2018032109073556.png" alt="zabbix03" /></p>

<p>4、更进一步
内存不足10% 这个时候服务器内存资源已经比较紧张，可以利用这个触发器触发一个脚本来重启占用内存比较多的服务，单实例无集群的服务不能用此方法，最好对服务也做好监控，要不然自动重启服务失败，就尴尬了。</p>

<h3 id="监控服务器cpu">监控服务器CPU</h3>

<p>需要的效果，linux主机cpu使用率超过90%的时候报警。linux默认的模板中无此项，只有cpu的负载，当负载在一定时间内5以上报警。我们在cpu utilization中找到一个cpu idle时间，即cpu的空闲时间，当空闲时间小于10%的时候就是cpu大于90%的时候。</p>

<p>在linux模板中添加触发器</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name:
cpu user percent gt 90%

Expression:
<span class="o">{</span>Template OS Linux:system.cpu.util[,idle].avg<span class="o">(</span>1m<span class="o">)}</span>&lt;10
</code></pre></div></div>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321094921538.png" alt="zabbix03" /></p>

<hr />

<h3 id="监控流量">监控流量</h3>

<p>为了防止某台机器流量过高导致网络慢，或者因为中病毒或木马等原因，导致流量很高，可使用zabbix的流量告警功能来对流量进行告警。</p>

<p>配置告警路径：
Configuration–Templates–Template OS Linux–Discovery–Network interface discovery–Trigger Prototypes–Create trigger prototype</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-2018032110381992.png" alt="zabbix04" /></p>

<p>在Add，添加Item时要选择Select prototype；Function选择Average value of a period T is &gt; N ; N 的值为50000000（我这是设置为超过50MB才告警，请自行根据需要设置大小）</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321104721552.png" alt="zabbix05" /></p>

<p><img src="/images/posts/zabbix/markdown-img-paste-2018032110450356.png" alt="zabbix06" /></p>

<p><img src="/images/posts/zabbix/markdown-img-paste-2018032110494494.png" alt="zabbix07" /></p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321105022384.png" alt="zabbix08" /></p>

<hr />

<h3 id="监控磁盘空间">监控磁盘空间</h3>
<p>对磁盘容量的监控，zabbix自带的linux模板中已有配置，让我们来看看配置在哪里，另外稍改下配置来做做实验，测试一下效果。
位置在这里
<img src="/images/posts/zabbix/markdown-img-paste-20180321113837317.png" alt="zabbix09" /></p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321171901104.png" alt="zabbix10" /></p>

<p>修改触发器的值，20改为80，让可用磁盘空间超过 20%就触发报警，这是做测试用，测试OK后再改回来</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-20180321172112297.png" alt="zabbix11" /></p>

<p>收到的邮件报警效果</p>

<p><img src="/images/posts/zabbix/markdown-img-paste-2018032117223285.png" alt="zabbix12" /></p>

<hr />

<h3 id="参考资料">参考资料</h3>

<p><a href="https://www.zabbix.com/documentation/3.4/zh/manual/config/notifications/media/script">官方文档 Zabbix Documentation 3.4</a></p>

<p><a href="http://www.zabbix.org.cn/">ZABBIX中文社区</a></p>

<p><a href="http://www.cnblogs.com/rysinal/p/5834421.html">zabbix3.0.4 邮件告警详细配置</a></p>

<p><a href="http://www.ttlsa.com/linux/use-sendemail/">如何使用sendEmail发送邮件</a></p>

<p><a href="http://blog.csdn.net/reblue520/article/category/6403502">reblue520的zabbix专栏</a></p>

<p><a href="https://www.kubernetes.org.cn/1954.html">用 Prometheus 来监控你的 Kubernetes 集群</a></p>

<hr />

<p><strong>转载</strong>请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权，版权归 <a href="https://baxibaba.github.io">baxibaba</a> 所有。</p>

    </article>
    <div class="share">
      <div class="share-component"></div>
    </div>
    <div class="comment">
      

  

  
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
        <script>
        var gitalk = new Gitalk({
            id: '/2018/03/15/docker-zabbix-email/',
            clientID: 'd2e1cbbd298958076462',
            clientSecret: 'b42a4178e5fd4a7cf63189ef4b1453b05c375709',
            repo: 'blog-comments',
            owner: 'liuyw',
            admin: ['liuyw'],
            labels: ['gitment'],
            perPage: 50,
        })
        gitalk.render('gitalk-container')
        </script>
  


    </div>
  </div>
  <div class="column one-fourth">
    
<h3>Search</h3>
<div id="site_search">
    <input type="text" id="search_box" placeholder="Search">
</div>

<ul id="search_results"></ul>

<link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/modules/sidebar-search.css">
<script src="http://localhost:4000/assets/js/jekyll-search.min.js"></script>
<script src="http://localhost:4000/assets/js/search.js"></script>

<script type="text/javascript">
SimpleJekyllSearch({
    searchInput: document.getElementById('search_box'),
    resultsContainer: document.getElementById('search_results'),
    json: 'http://localhost:4000/assets/search_data.json',
    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false,
    exclude: ['Welcome']
})
</script>

    

    
<h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
<div id="post-directory-module" class="mobile-hidden">
  <section class="post-directory">
  <!-- Links that trigger the jumping -->
  <!-- Added by javascript below -->
  <dl></dl>
  </section>
</div>

<script src="http://localhost:4000/assets/js/jquery.toc.js"></script>

  </div>
</div>
</section>
<!-- /section.content -->

    <footer class="container">
        <div class="site-footer" role="contentinfo">
            <div class="copyright left mobile-block">
                    © 2020
                    <span title="Wanbao Chen">Wanbao Chen</span>
                    <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
            </div>

            <ul class="site-footer-links right mobile-hidden">
                <li>
                    <a href="javascript:window.scrollTo(0,0)" >TOP</a>
                </li>
            </ul>
            <a href="https://github.com/able615/able615.github.io" target="_blank" aria-label="view source code">
                <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
            </a>
            <ul class="site-footer-links mobile-hidden">
                
                <li>
                    <a href="http://localhost:4000/" title="首页" target="">首页</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/categories/" title="分类" target="">分类</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/wiki/" title="维基" target="">维基</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/links/" title="链接" target="">链接</a>
                </li>
                
                <li>
                    <a href="http://localhost:4000/about/" title="关于" target="">关于</a>
                </li>
                
                <li><a href="http://localhost:4000/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
            </ul>

        </div>
    </footer>
    <!-- / footer -->
    <script src="http://localhost:4000/assets/vendor/share.js/dist/js/share.min.js"></script>
    <script src="http://localhost:4000/assets/js/geopattern.js"></script>
    <script src="http://localhost:4000/assets/js/prism.js"></script>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/globals/prism.css">
    <script>
      jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
          $(this).geopattern($(this).data('pattern-id'));
        });
       // hljs.initHighlightingOnLoad();
      });
    </script>

    

    

    

    

    
    <div style="display:none">
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-80669434-1', 'auto');
        ga('send', 'pageview');

      </script>
    </div>
    
</body>
</html>
